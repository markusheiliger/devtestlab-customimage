name: Build Images

env:
  location: westeurope

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
    # paths:
    #       - '**/packer.json'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:

  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Azure Resources
        run: |
          RESULT=$(az deployment sub create --location ${{ env.location }} --template-file ./arm/azuredeploy.json -o json)
          echo "$RESUT"
          echo "$RESULT" | jq --raw-output '.properties.outputs.resourceGroup.value'
          echo "$RESULT" | jq --raw-output '.properties.outputs.galleryName.value'
          echo "::set-output name=resourceGroup::$(echo "$RESULT" | jq './properties/outputs/resourceGroup/value')"
          echo "::set-output name=galleryName::$(echo "$RESULT" | jq .)"

      - id: packer-definitions
        name: Detect Packer Definitions
        run: | 
          echo "::set-output name=matrix::$(find . -type f -name 'packer.json' | jq -R -s -c 'split("\n")[:-1]')"

    outputs:
        matrix: ${{ steps.packer-definitions.outputs.matrix }}

  build:
    needs: prepare
    runs-on: ubuntu-latest

    strategy:
        matrix:
            imagePath: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v2

      - name: Fetch tags for GitVersion
        run: git fetch --tags

      - name: Fetch main for GitVersion
        if: github.ref != 'refs/heads/main'
        run: git branch --create-reflog main origin/main

      - name: GitVersion
        id: gitversion 
        uses: roryprimrose/rungitversion@v1.0.0

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Packer
        uses: hashicorp-contrib/setup-packer@v1.0.0

      - name: Build Image
        run: |
          IMAGE="$(basename "$(dirname "${{ matrix.imagePath }}")")"
          SUBSCRIPTION="$(az account show --query 'id' -o tsv)"
          RESOURCEGROUP=""
          GALLERYNAME=""
          packer build -var "image=$IMAGE" -var "version=${{ steps.gitversion.outputs.MajorMinorPatch }}" -var "location=${{ env.location }}" -var "subscription=$SUBSCRIPTION" -var "resourceGroup=$RESOURCEGROUP" -var "galleryName=$GALLERYNAME" "${{ matrix.imagePath }}" 
