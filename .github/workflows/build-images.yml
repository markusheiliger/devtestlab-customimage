name: Build Images

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
    # paths:
    #       - '**/packer.json'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:

  prepare:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - id: packer-definitions
        name: Detect Packer Definitions
        run: | 
          find . -type f -name 'packer.json' | sed -r 's|/[^/]+$||' | sort -u | jq -R -s -c 'split("\n")[:-1]'
          echo "::set-output name=matrix::$(find . -type f -name 'packer.json' | sed -r 's|/[^/]+$||' | sort -u | jq -R -s -c 'split("\n")[:-1]')"

    outputs:
        matrix: ${{ steps.packer-definitions.outputs.matrix }}

  build:
    needs: prepare
    runs-on: ubuntu-latest

    strategy:
        matrix:
            imagePath: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v2

      - run: echo "${{ matrix.imagePath }}"
      # - name: Login to Azure
      #   uses: azure/login@v1
      #   with:
      #     creds: ${{ secrets.AZURE_CREDENTIALS }}
